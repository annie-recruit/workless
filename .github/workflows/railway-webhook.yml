name: Railway Deployment Monitor

on:
  repository_dispatch:
    types: [railway-deployment-failed]
  workflow_dispatch:
    inputs:
      error_log:
        description: 'Error log from Railway'
        required: false

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Parse error log
        id: parse_error
        run: |
          ERROR_LOG="${{ github.event.client_payload.error_log || github.event.inputs.error_log || '' }}"
          echo "error_found=true" >> $GITHUB_OUTPUT
          echo "error_log<<EOF" >> $GITHUB_OUTPUT
          echo "$ERROR_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create issue with error details
        if: steps.parse_error.outputs.error_found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errorLog = `${{ steps.parse_error.outputs.error_log }}`;
            
            // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ íŒ¨í„´ ë¶„ì„
            const patterns = [
              { pattern: /Cannot find name '(\w+)'/, fix: 'ë³€ìˆ˜/í•¨ìˆ˜ ì´ë¦„ ì˜¤íƒ€ ë˜ëŠ” import ëˆ„ë½' },
              { pattern: /Type error: Cannot find name/, fix: 'íƒ€ì… ì •ì˜ ëˆ„ë½ ë˜ëŠ” import ëˆ„ë½' },
              { pattern: /Module not found/, fix: 'íŒ¨í‚¤ì§€ ì„¤ì¹˜ í•„ìš” ë˜ëŠ” import ê²½ë¡œ ì˜¤ë¥˜' },
              { pattern: /is not defined/, fix: 'ë³€ìˆ˜/í•¨ìˆ˜ ì •ì˜ ëˆ„ë½' },
              { pattern: /Unexpected token/, fix: 'ë¬¸ë²• ì˜¤ë¥˜ (ê´„í˜¸, ì„¸ë¯¸ì½œë¡  ë“±)' },
            ];
            
            let detectedIssues = [];
            for (const { pattern, fix } of patterns) {
              const match = errorLog.match(pattern);
              if (match) {
                detectedIssues.push(`- **${match[0]}**: ${fix}`);
              }
            }
            
            const title = `ğŸš¨ Railway ë°°í¬ ì‹¤íŒ¨ - ${new Date().toISOString()}`;
            let body = `## Railway ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
            
            **ì‹œê°„:** ${new Date().toISOString()}
            **ë¸Œëœì¹˜:** ${{ github.ref }}
            **ì»¤ë°‹:** ${{ github.sha }}
            
            ### ê°ì§€ëœ ì˜¤ë¥˜:
            \`\`\`
            ${errorLog.substring(0, 5000)}
            \`\`\`
            `;
            
            if (detectedIssues.length > 0) {
              body += `\n### ê°€ëŠ¥í•œ ì›ì¸ ë° í•´ê²° ë°©ë²•:\n${detectedIssues.join('\n')}\n`;
            }
            
            body += `\n### ë‹¤ìŒ ë‹¨ê³„:\n1. ì˜¤ë¥˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”\n2. ë¡œì»¬ì—ì„œ \`npm run build\`ë¡œ ì¬í˜„í•´ë³´ì„¸ìš”\n3. ìˆ˜ì • í›„ ë‹¤ì‹œ ë°°í¬í•˜ì„¸ìš”\n`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'deployment', 'railway']
            });
